Locust:
------
------
------


Tutorial 1: Getting Started with Locust:
--------------------------------------


Locust is the load testing tool.
It uses python
It is open source


Prerequest:
minimum python 3.6 or above


To install use below command

pip install locust
or
pip3 install locust

locust -V   //This will show the version of locust



Locust will support multiple protocols. By default it comes with http and https
Load testing can be done in distributed environment. Can have multiple nodes with master and slave architecture

We can use any IDE. I will use pycharm here


Open pycharm
Create project
Give project name
Give environment as virtual env and select python version base interpreter



---------------

Tutorial 2: user class:
-------------------

Below are frequently used class in locust
User
HttpUser
TaskSet
SequentialTaskSet
httpSession
Response
ResponseContextManager
Environment
Runner
WebUI



User class is the simple class used to create users to attach the system


Inside User class we can make use of below variables and methods to achive the test

abstract = True
on_start()
on_stop()
tasks
wait()
wait_time()
weight = 10


To go into env use below command
.\venv\Scripts\activate.bat


To come out of the env use below command
.\venv\Scripts\deactivate.bat



Create sample file in root with file name as app

Eg:

from locust import User, task


class MyUsers(User):

    @task
    def launch(self):
        print("launch da")

    @task
    def search(self):
        print("search da")


To run use below command

locust -f filename            //This command is used to execute
Eg:
locust -f app.js


http://localhost:8089/         //in browser open this and give total number of users, users per sec etc


Give total users, user per sec etc

We can stop the test in UI


Example with multiple users:

from locust import User, task, constant


class MyUsers(User):
    weight = 2         //How much weightable of users we should give
    wait_time = constant(1)

    @task
    def launch(self):
        print("launch da")

    @task
    def search(self):
        print("search da")


class MyUsers2(User):
    weight = 2    //How much weightable of users we should give
    wait_time = constant(1)

    @task
    def launch2(self):
        print("launch 2 da")

    @task
    def search2(self):
        print("search 2 da")



Number of users (peak concurrency): //How many task we have given give simular 
In above case, we will give 4 to pick all 4

Spawn rate (users started/second): 
This also matters




-------------


Tutorial 3: HttpUser class
----------------------

HttpUser is used to call http calls
It has client and different methods like get, post, put, delete etc
We can use this for api load testing.

Example:

from locust import HttpUser, task, constant

class MyHttpUsers(HttpUser):
    host = "https://reqres.in"           //host parameter is important. it will this host. If we not given, then we have to  pass while running as like --host="https://reqres.in"
    wait_time = constant(1)

    @task
    def get_users(self):
        self.client.get('/api/users?page=2')  //Get method

    @task
    def create_user(self):
        self.client.post('/api/users', data='''{ "name": "morpheus", "job": "leader" }''')  //Post method by passing json body



Example 2:
from locust import HttpUser, task, constant

class MyHttpUsers(HttpUser):
    wait_time = constant(1)

    @task
    def get_users(self):
        res = self.client.get('/api/users?page=2')
        print(res.status_code)    //printing status code
        print(res.headers)        //printing all headers
        print(res.text)           //printing response body

    @task
    def create_user(self):
        res = self.client.post('/api/users', data='''{ "name": "morpheus", "job": "leader" }''')
        print(res.status_code)
        print(res.headers)
        print(res.text)



In example 2, i have not used host. So i will past host when running. Eg: locust -f filename.js --host="https://reqres.in"

----------

Tutorial 4: Learn locust series: TaskSet class Part 1
------------------------------------------------------

TaskSet will have many tasks.
We should have User or HttpUser and add all TaskSet in task, then only it will work.

Eg:   //file name is myendpoints.py  . It is under alltasksets

from locust import TaskSet, constant, task, HttpUser
import random

class MyApisTask(TaskSet):

    @task
    def get_page_api(self):
        self.client.get('/api/users?page=2')
        print('Get api page 2')

    @task
    def get_differnt_id_api(self):
        ids = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13]
        random_endpoint = "/api/users/" + str(random.choice(ids))
        self.client.get(random_endpoint)
        print('Each api with id')

class MyUser(HttpUser):
    host = "https://reqres.in"
    tasks = [MyApisTask]                          //We can have multiple taskset
    wait_time = constant(1)



To run give below command:
locust -f alltasksets\myenpoints.py

Then give in UI


-----------

Tutorial 5:TaskSet class Part 2
--------------------------------
Two way we can have multiple taskSet class.
1. Nested taskset class
2. 2 seperate class for taskset

Nested taskset class:
We can have nested taskset class. (taskset class inside another taskset class)
to come out of the inner nested taskset class we need to use self.interrupt(). Else it will loop into same class
To give breathing time use self.interrupt(reschedule = False). So that it will give breathing time. By default reschedule will be True. so we are changing to False

Eg:
from locust import TaskSet, task, constant, HttpUser

class MyTaskSet1(TaskSet):

    @task
    def first_api(self):
        res = self.client.get('/api/users/2')
        print('First api')

    @task
    class MyTaskSetNested(TaskSet):

        @task
        def second_api(self):
            res = self.client.get('/api/users?page=2')
            print('Second api')
            self.interrupt(reschedule = False)

class MyHttp(HttpUser):
    host = "https://reqres.in"
    tasks = [MyTaskSet1]
    wait_time = constant(1)




2 seperate class for taskset:
We can add all taskset class in tasks of user / httpuser class
tasks = [Mytaskset1, mytaskset2]
also use self.interrupt(), else it will loop into same class
To give breathing time use self.interrupt(reschedule = False) in both task method of both class. So that it will give breathing time. By default reschedule will be True. so we are changing to False.

Eg:
from locust import TaskSet, task, constant, HttpUser


class MyTaskSet1(TaskSet):

    @task
    def first_api(self):
        self.client.get('/api/users/2')
        print('First api')
        self.interrupt(reschedule=False)


class MyTaskSet2(TaskSet):

    @task
    def second_api(self):
        self.client.get('/api/users?page=2')
        print('Second api')
        self.interrupt(reschedule=False)


class MyHttpUser(HttpUser):
    host = "https://reqres.in"
    tasks = [MyTaskSet1, MyTaskSet2]
    wait_time = constant(1)



---------------


Tutorial 6: Sequential Task Set
-------------------------------

SequentialTaskSet
This is simular to TaskSet. But SequentialTaskSet will run each task one by one. It will run each task in sequence

Example:
from locust import SequentialTaskSet, constant, task, HttpUser


class MySequentialTask(SequentialTaskSet):

    @task
    def api_one(self):
        self.client.get('/api/users?page=2')
        print('First api')

    @task
    def api_second(self):
        self.client.get('/api/users/5')
        print('Second api')


class MyHttpUser(HttpUser):
    host = "https://reqres.in"
    tasks = [MySequentialTask]
    wait_time = constant(1)


----------

Tutorial 7: Wait time function
-------------------------------

Three 3 types of wait time we can give
Eg:
wait_time = constant(2)   //Constant wait time . In this example it will wait 2 sec after each task
wait_time = between(5, 10)  //This will take random time between given two values. In this example, it will take wait time randomly between 5 sec to 10 for each task
wait_time = constant_pacing(3) //This is minimum time a task should take. In this example we have given 3 sec, so it will take minimum 3 sec for each task. Does not matter how fast it is. still it will for 3 sec. Does not worry about if task takes more than 3 sec. Just will say take minimum 3 sec for an task. thats it



Example for constant:

from locust import User, constant, task

class MyUser(User):

    wait_time = constant(5)        //Wait for 5 sec in every task

    @task
    def my_task(self):
        print('My task. It will wait for 2 sec as constant is 2 sec')



Example for between:

from locust import task, User, between


class MyUser(User):
    wait_time = between(2, 5)

    @task
    def my_task(self):
        print('This task will randomly wait between 2 to 5 sec')



Example for constant_pacing:

from locust import User, task, constant_pacing
import time


class MyUser(User):

    wait_time = constant_pacing(5)

    @task
    def my_task(self):
        time.sleep(2)         //Here sleep is 2, so it will wait for 2 sec, As constant pacing is 5, it will wait 3 more sec to achive 5 sec (2+3 = 5) //Minimum it should wait for 5 sec
        print('My task. It will wait for 5 sec') 


constant_pacing Example with  more wait inside task it self:

from locust import User, task, constant_pacing
import time


class MyUser(User):

    wait_time = constant_pacing(5)

    @task
    def my_task(self):
        time.sleep(10) //It will wait for 10 sec. Miniumum it should wait for 5 as per constant_parsing. So it will wait for 10 sec sleep and go further
        print('My task. It will wait for 10 sec')


------------

Tutorial 8: Command line option part 1:
--------------------------------------
locust -h    //This will give all available commands in locust

Sample commnad to run load test and geting the result
locust -f script.py -u 10 -r 2 -t 10s --headless --print-stats --csv result.csv --csv-full-history --host=http://hostname.com
-f  //this is to give script file name with path
-u   //This is for giving number of users. It is will number of users per sec. If it is 5, it will call 5 users
-r   //number of per sec. if we give 2 as -r, then it will use above users in give -r. We can use -r 1. So that it will take above users in 1 sec
-t   //total time of performance test.Here s meaning sec, m meaning minutes, h mearing hours. Eg: 10s - 10 sec, 1h - 1 hour, 2m - 2 mins
--headless   //To run without opening locust webUI
--print-stats   //To print stats result in terminal
--csv   //To store result in csv file. Give file name Eg: --csv result.csv
--csv-full-history   //To store full csv result in csv file
--host       //To give host name


Eg:
locust -f tutorial8samplescriptforcheckingthecommand.py -u 6 -r 1 -t 10s --headless --print-stats --csv result.csv --csv-full-history --host=https://reqres.in


//This will run and generate 4 csv files. files for exceptions, failures, stats and stats history
//We can use sample command for running in CICD also

Used below sample file:

from locust import HttpUser, task, constant


class MyHttpUser(HttpUser):
    wait_time = constant(1)

    @task
    def my_api(self):
        res = self.client.get('/api/users?page=2')
        print('Called the api. response is:', res.status_code)

---------

Tutorial 8: Command line option part 2:
--------------------------------------

-L DEBUG --logfile filename.logs    //This is storing load test log files. we can give log level. We can give any of the them in DEBUG/INFO/WARNING/ERROR/CRITICAL

--html htmlfoldername.html

locust -f script.py -u 10 -r 2 -t 10s --headless --print-stats --csv result.csv --csv-full-history --host=http://hostname.com -L DEBUG --logfile filename.logs --html htmlfoldername


locust -f script.py -l   //This will list all users classes

locust -f script.py --show-task-ratio    //This will show task execution ratio. Show how the load will be splited if we run.

locust -f script.py --show-task-ratio-json    //This will show task execution ratio in json format. Show how the load will be splited if we run. It will show above in json format



Sample file:
from locust import HttpUser, task, constant

class MyHttpUsers(HttpUser):
    host = "https://reqres.in"
    wait_time = constant(1)

    @task
    def get_users(self):
        self.client.get('/api/users?page=2')

    @task
    def create_user(self):
        self.client.post('/api/users', data='''{ "name": "morpheus", "job": "leader" }''')





Commands:

locust -f tutorial9commandsWithLogsAndHtmletc.py -l

locust -f tutorial9commandsWithLogsAndHtmletc.py --show-task-ratio

locust -f tutorial9commandsWithLogsAndHtmletc.py --show-task-ratio-json 

locust -f tutorial9commandsWithLogsAndHtmletc.py -u 2 -r 3 -t 20s --headless --print-stats --host=https://reqres.in -L DEBUG --logfile test.log --html uireport.html


-------------

To run in UI:
-------
--------

Go to virtual env first using below command

.\venv\Scripts\activate.bat



To launch use below command.

locust -f filename.js //This will start running the locust. Also show the url of locust UI.

Open browser and give url which is showing in above logs. Eg: http://localhost:8089/

Then we can give number of users, user per sec and host //these things we can also give in command line also like host etc
Click start swarming

Then it will start running.

UI will few options.
statistics - this will give more details about number of request, respons time, 90%ile, 99%ile, failure and more
Chart - will give the number of request per sec, response time and number of users etc in each time
Failure - this will give details about failure
Exception - this will give if any exception occurs in our load script when load running
Current ratio - this will ratio per user class and total ratio
Download data - here we can download the result in csv file


We can stop by clicking stop button in statistics
We can also click new test to again run the tes 


---



-----------------
